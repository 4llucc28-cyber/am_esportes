<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO DASHBOARD | AM Esportes</title>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ffc200;
            --bg-dark: #0f0f0f;
            --bg-card: #1a1a1a;
            --text-gray: #888;
            --danger: #ff3b30;
            --success: #00a650;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: white;
            display: flex;
            height: 100vh; /* Trava a altura da tela */
            overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: #111;
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            height: 100%;
            overflow-y: auto;
        }
        .logo {
            font-family: 'Barlow Condensed';
            font-size: 2rem;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 50px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
        }
        .menu-item {
            padding: 15px;
            margin-bottom: 8px;
            color: #666;
            cursor: pointer;
            border-radius: 10px;
            display: flex; align-items: center; gap: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 194, 0, 0.1);
            color: var(--primary);
        }
        
        .logout-btn {
            margin-top: auto;
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        .logout-btn:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto; /* Scroll só aqui dentro */
            position: relative;
            height: 100%;
        }

        /* HEADER */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 40px;
        }
        .page-title h1 { font-family: 'Barlow Condensed'; font-size: 2.5rem; }
        .page-title p { color: #666; font-size: 0.9rem; }
        .date-display { 
            background: #222; padding: 10px 20px; border-radius: 30px; 
            font-size: 0.9rem; color: #aaa; border: 1px solid #333;
        }

        /* KPI CARDS */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .kpi-card {
            background: var(--bg-card); padding: 25px; border-radius: 16px;
            border: 1px solid #333; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 140px;
        }
        .kpi-value { font-size: 2.2rem; font-weight: 700; color: white; font-family: 'Barlow Condensed'; }
        .kpi-trend { font-size: 0.8rem; margin-top: 5px; }
        .trend-up { color: var(--success); }

        /* CHARTS FIX (CORREÇÃO DO BUG INFINITO) */
        .charts-row {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
            /* Remove altura fixa do grid para evitar conflito */
        }
        .chart-box {
            background: var(--bg-card); border-radius: 16px; border: 1px solid #333;
            padding: 25px; position: relative;
            display: flex; flex-direction: column;
        }
        .chart-container-wrapper {
            position: relative;
            height: 300px; /* Altura fixa PARA O GRÁFICO */
            width: 100%;
        }
        
        /* TOP PRODUCTS */
        .top-products-list { overflow-y: auto; max-height: 300px; padding-right: 5px; }
        .top-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid #333;
        }
        .top-item img { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #333; }
        .top-item-views { font-family: 'Barlow Condensed'; font-size: 1.2rem; color: var(--primary); font-weight: bold; }

        /* FORMS & INPUTS */
        .admin-form { display: grid; gap: 20px; max-width: 800px; }
        .input-group label { display: block; color: var(--text-gray); margin-bottom: 8px; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; background: #0a0a0a; border: 1px solid #333; color: white;
            padding: 15px; border-radius: 8px; outline: none; transition: 0.3s;
            font-family: 'Inter';
        }
        input:focus { border-color: var(--primary); }
        
        .btn-primary {
            background: var(--primary); color: #000; border: none; padding: 15px 30px;
            border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s;
            font-family: 'Barlow Condensed'; font-size: 1.2rem; text-transform: uppercase;
            width: fit-content; display: flex; align-items: center; gap: 10px;
        }
        
        /* ESTILO PARA MÚLTIPLAS FOTOS */
        .url-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-add-foto {
            background: transparent; border: 1px dashed #444; color: var(--primary);
            padding: 10px; width: 100%; cursor: pointer; border-radius: 8px;
            font-weight: bold; text-transform: uppercase; font-size: 0.8rem;
        }
        .btn-add-foto:hover { background: rgba(255,194,0,0.05); border-color: var(--primary); }
        .btn-remove-foto {
            background: #222; color: var(--danger); border: 1px solid #333;
            width: 50px; cursor: pointer; border-radius: 8px;
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 1024px) {
            body { flex-direction: column; overflow: auto; height: auto; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; height: auto; }
            .charts-row { grid-template-columns: 1fr; }
            .menu-item span { display: none; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo"><i class="fas fa-shield-halved"></i> <span>AM ADMIN</span></div>
        <div class="menu-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-line"></i> <span>Visão Geral</span></div>
        <div class="menu-item" onclick="switchTab('produtos', this)"><i class="fas fa-tshirt"></i> <span>Produtos</span></div>
        <div class="menu-item" onclick="switchTab('config', this)"><i class="fas fa-cog"></i> <span>Configurações</span></div>
        <div class="menu-item logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></div>
    </nav>

    <main class="main-content">
        <header class="page-header">
            <div class="page-title"><h1 id="page-title-text">DASHBOARD</h1><p>Painel de Controle Oficial</p></div>
            <div class="date-display" id="current-date">DATA</div>
        </header>

        <div id="tab-dashboard" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-views">0</div>
                    <div class="kpi-trend trend-up">Visualizações Totais</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-products">0</div>
                    <div class="kpi-trend">Produtos em Estoque</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" style="color:var(--primary);">ON</div>
                    <div class="kpi-trend trend-up">Sistema Operante</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <div class="chart-header" style="margin-bottom:20px;"><h3>Acessos da Semana</h3></div>
                    <div class="chart-container-wrapper">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-header" style="margin-bottom:20px;"><h3>Top Produtos</h3></div>
                    <div class="top-products-list" id="top-products-dash"></div>
                </div>
            </div>
        </div>

        <div id="tab-produtos" class="tab-content">
            <div style="background: var(--bg-card); padding: 30px; border-radius: 16px; border: 1px solid #333; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--primary);">NOVO DROP</h3>
                <form id="form-produto" class="admin-form">
                    <div class="input-group"><label>Nome</label><input type="text" id="prod-nome" required></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="input-group"><label>Preço (R$)</label><input type="number" step="0.01" id="prod-preco" required></div>
                        <div class="input-group"><label>Categoria</label><select id="prod-categoria" required><option value="">Carregando...</option></select></div>
                    </div>
                    <div class="input-group"><label>Time / Marca</label><input type="text" id="prod-time" required></div>
                    
                    <div class="input-group">
                        <label>Galeria de Imagens</label>
                        <div id="images-container">
                            <div class="url-row">
                                <input type="text" class="prod-img-input" placeholder="URL da Foto 1 (Capa)" required>
                            </div>
                        </div>
                        <button type="button" class="btn-add-foto" onclick="addPhotoField()">+ Adicionar outra foto</button>
                    </div>

                    <div class="input-group"><label>Descrição</label><textarea id="prod-desc" rows="3"></textarea></div>
                    <button type="submit" class="btn-primary">SALVAR PRODUTO</button>
                </form>
            </div>

            <h3 style="margin-bottom: 15px;">ESTOQUE</h3>
            <div id="lista-produtos" style="display: grid; gap: 10px;"></div>
        </div>

        <div id="tab-config" class="tab-content">
            <div style="max-width: 600px; background: var(--bg-card); padding: 30px; border-radius: 16px; border: 1px solid #333;">
                <h3 style="color: var(--primary); margin-bottom: 25px;">SISTEMA</h3>
                <div class="input-group" style="margin-bottom: 20px;"><label>Banner (URL)</label><input type="text" id="cfg-banner"></div>
                <div class="input-group" style="margin-bottom: 20px;"><label>WhatsApp (DDD+Num)</label><input type="text" id="cfg-whatsapp"></div>
                <div class="input-group" style="margin-bottom: 20px;"><label>E-mail</label><input type="email" id="cfg-email"></div>
                <button onclick="salvarConfig()" class="btn-primary" style="width: 100%; justify-content: center;">ATUALIZAR</button>
                
                <hr style="border:0; border-top:1px solid #333; margin:30px 0;">
                
                <h4 style="color: white; margin-bottom: 10px;">Nova Categoria</h4>
                <form id="form-categoria" style="display: flex; gap: 10px;">
                    <input type="text" id="cat-nome" placeholder="Nome" required style="flex: 2;">
                    <input type="text" id="cat-slug" placeholder="slug" required style="flex: 1;">
                    <button type="submit" class="btn-primary" style="padding: 0 20px;">OK</button>
                </form>
                <div id="lista-categorias" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db, onAuthStateChanged, signOut, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, setDoc, getDoc } from './firebase-config.js';

        const EMAIL_ADMIN = "admin@amesportes.com";

        // VERIFICAÇÃO DE SEGURANÇA
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === EMAIL_ADMIN) {
                initDashboard();
            } else {
                document.body.innerHTML = '<div style="height:100vh; display:flex; justify-content:center; align-items:center; color:white; flex-direction:column;"><h1>ACESSO RESTRITO</h1><a href="index.html" style="color:#ffc200; margin-top:20px;">Voltar</a></div>';
            }
        });

        async function initDashboard() {
            const d = new Date();
            const months = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
            document.getElementById('current-date').innerText = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
            await loadConfigs();
            await loadData();
            initChart();
        }

        // --- SISTEMA DE FOTOS MÚLTIPLAS ---
        window.addPhotoField = () => {
            const container = document.getElementById('images-container');
            const div = document.createElement('div');
            div.className = 'url-row';
            div.innerHTML = `
                <input type="text" class="prod-img-input" placeholder="URL da Foto Extra">
                <button type="button" class="btn-remove-foto" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        async function loadData() {
            // CATEGORIAS
            const catSnap = await getDocs(collection(db, "categorias"));
            const catSelect = document.getElementById('prod-categoria');
            const catList = document.getElementById('lista-categorias');
            catSelect.innerHTML = '<option value="">Selecione...</option>';
            catList.innerHTML = '';
            catSnap.forEach(d => {
                const c = d.data();
                catSelect.innerHTML += `<option value="${c.slug}">${c.nome}</option>`;
                catList.innerHTML += `<span style="background:#333; padding:5px 10px; border-radius:4px; font-size:0.8rem; display:flex; align-items:center; gap:5px;">${c.nome} <i class="fas fa-times" style="cursor:pointer; color:red;" onclick="window.delCat('${d.id}')"></i></span>`;
            });

            // PRODUTOS
            const prodSnap = await getDocs(query(collection(db, "produtos"), orderBy("dataCriacao", "desc")));
            const listEl = document.getElementById('lista-produtos');
            const listTop = document.getElementById('top-products-dash');
            listEl.innerHTML = ''; listTop.innerHTML = '';
            
            let products = [];
            let totalViews = 0;

            prodSnap.forEach(d => {
                const p = d.data();
                const thumb = Array.isArray(p.img) ? p.img[0] : p.img; // Pega a primeira foto
                products.push({...p, id: d.id, thumb});
                totalViews += (p.views || 0);

                listEl.innerHTML += `
                    <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--primary);">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <img src="${thumb}" style="width:50px; height:50px; object-fit:cover; border-radius:6px; background:#333;">
                            <div><div style="font-weight:bold;">${p.nome}</div><div style="font-size:0.8rem; color:#888;">${p.categoria} | R$ ${p.preco}</div></div>
                        </div>
                        <div style="display:flex; gap:15px; align-items:center;">
                            <span style="font-size:0.9rem; color:#aaa;"><i class="fas fa-eye"></i> ${p.views || 0}</span>
                            <button onclick="window.delProd('${d.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });

            // TOP 5
            products.sort((a, b) => (b.views || 0) - (a.views || 0));
            products.slice(0, 5).forEach(p => {
                listTop.innerHTML += `
                    <div class="top-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.thumb}">
                            <div><div style="font-weight:600; font-size:0.9rem;">${p.nome.substring(0, 20)}...</div><small style="color:#666;">${p.time || '-'}</small></div>
                        </div>
                        <div class="top-item-views">${p.views || 0}</div>
                    </div>`;
            });

            document.getElementById('kpi-products').innerText = products.length;
            document.getElementById('kpi-views').innerText = totalViews;
        }

        // SALVAR PRODUTO COM MULTIPLAS FOTOS
        document.getElementById('form-produto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = "Salvando..."; btn.disabled = true;

            try {
                // Coleta todas as URLs dos inputs
                const imgInputs = document.querySelectorAll('.prod-img-input');
                const images = Array.from(imgInputs).map(input => input.value).filter(val => val.trim() !== "");

                await addDoc(collection(db, "produtos"), {
                    nome: document.getElementById('prod-nome').value,
                    preco: parseFloat(document.getElementById('prod-preco').value),
                    categoria: document.getElementById('prod-categoria').value,
                    time: document.getElementById('prod-time').value,
                    img: images, // Salva o Array de fotos
                    descricao: document.getElementById('prod-desc').value,
                    dataCriacao: new Date(),
                    views: 0
                });
                alert("Produto Publicado!");
                e.target.reset();
                // Reseta o campo de imagens para ter só 1 input
                document.getElementById('images-container').innerHTML = '<div class="url-row"><input type="text" class="prod-img-input" placeholder="URL da Foto 1 (Capa)" required></div>';
                loadData();
            } catch(err) { alert(err.message); }
            btn.innerHTML = "SALVAR PRODUTO"; btn.disabled = false;
        });

        // OUTRAS FUNÇÕES
        async function loadConfigs() {
            try {
                const docSnap = await getDoc(doc(db, "site_config", "geral"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.banner) document.getElementById('cfg-banner').value = data.banner;
                    if(data.whatsapp) document.getElementById('cfg-whatsapp').value = data.whatsapp;
                    if(data.email) document.getElementById('cfg-email').value = data.email;
                }
            } catch(e) {}
        }

        window.salvarConfig = async () => {
            const banner = document.getElementById('cfg-banner').value;
            const whatsapp = document.getElementById('cfg-whatsapp').value;
            const email = document.getElementById('cfg-email').value;
            if(banner) await setDoc(doc(db, "site_config", "hero"), { img: banner }, { merge: true });
            await setDoc(doc(db, "site_config", "geral"), { banner, whatsapp, email }, { merge: true });
            alert("Configurações Salvas!");
        }

        // CHART CONFIG (FIXADO)
        function initChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            // Destroi gráfico anterior se existir pra não bugar
            if(window.myChart) window.myChart.destroy();
            
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    datasets: [{
                        label: 'Acessos',
                        data: [150, 230, 180, 320, 450, 500, 420], // Dados Mockados
                        borderColor: '#ffc200',
                        backgroundColor: 'rgba(255, 194, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Importante pra respeitar a altura do pai
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        document.getElementById('form-categoria').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "categorias"), { 
                nome: document.getElementById('cat-nome').value, 
                slug: document.getElementById('cat-slug').value.toLowerCase() 
            });
            alert("Categoria Adicionada");
            e.target.reset();
            loadData();
        });

        window.delProd = async (id) => { if(confirm('Excluir?')) { await deleteDoc(doc(db, "produtos", id)); loadData(); } }
        window.delCat = async (id) => { if(confirm('Excluir?')) { await deleteDoc(doc(db, "categorias", id)); loadData(); } }
        window.logout = () => signOut(auth).then(()=>location.reload());
        
        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            const titles = { 'dashboard': 'DASHBOARD', 'produtos': 'GERENCIAR PRODUTOS', 'config': 'SISTEMA' };
            document.getElementById('page-title-text').innerText = titles[tabId];
        }
    </script>
</body>
</html>